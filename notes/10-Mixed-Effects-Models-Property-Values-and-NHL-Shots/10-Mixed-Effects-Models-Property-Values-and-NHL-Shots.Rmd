---
title: "Mixed effects models - Random Intercepts"
author: "S&DS 361"
date: "2024-04-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lme4)
library(MASS, exclude = 'select')
library(arm)
library(tidyverse)
library(pubtheme)
```

```{r}
b = read.csv('data/branford.csv')
b$log.living = log(b$living)
b$log.value  = log(b$value)
b$nghd = factor(b$nghd)
head(b)
```
Build two models, linear regression and mixed effects linear regression

```{r}
b1 =   lm(log.value ~ log.living +     style + beds + log(miles_to_coastline) +    nghd , data=b, 
          contrasts = list(nghd = "contr.sum", style = 'contr.sum'))
b2 = lmer(log.value ~ log.living + (1|style) + beds + log(miles_to_coastline) + (1|nghd), data=b)
```

Summaries

```{r}
summary(b1)
summary(b2)
```

## Create a function to extract coefficients

```{r}
extract.ranef = function(lmer.model=NULL, lm.model=NULL){
  
  vars = names(ranef(lmer.model))
  lmer.coefs = NULL
  lm.coefs = NULL
  
  if(!is.null(lm.model)){
    lm.coefs = summary(lm.model)$coefficients %>%
      as.data.frame() %>%
      rownames_to_column(var='var') %>%
      filter(grepl(paste0(vars, collapse = "|"), var)) %>%
      rename(est = 'Estimate',
             se  = 'Std. Error') %>%
      select(var, est, se) %>%
      mutate(model = 'glm')
  }
  
  for (j in vars){
    
    ## lmer
    est = ranef(lmer.model)[[j]] 
    se  = se.ranef(lmer.model)[[j]] 
    colnames(est) = 'est'
    colnames(se)  = 'se'
    temp = data.frame(var   = rownames(est), 
                      est   = est, 
                      se    = se, 
                      model = 'glmer',
                      ranef = j)
    lmer.coefs = rbind(lmer.coefs, temp)
    
    ## lm
    if(!is.null(lm.model)){
      rows=grepl(j, lm.coefs$var)
      lm.coefs$var[rows] = lm.model$xlevels[[j]][-length(lm.model$xlevels[[j]])]
      lm.coefs$ranef[rows] = j
      
    } ## if lm.model
    
  } ## end j loop
  
  coefs = rbind(lmer.coefs, lm.coefs)
  return(coefs)
}


extract.ranef(b2, b1)
```

Let's compare coefficients

```{r}
df = extract.ranef(b2, b1) 
head(df)
```
Let's find the number of observations for each `nghd` and `style`.

```{r}
n.obs.nghd = b %>% 
  group_by(nghd) %>% 
  summarise(n = n(), 
            value = mean(value)) %>% 
  rename(var = nghd) %>%
  mutate(ranef = 'nghd')
n.obs.nghd %>% head()

n.obs.style = b %>% 
  group_by(style) %>% 
  summarise(n = n(), 
            value = mean(value)) %>% 
  rename(var = style) %>%
  mutate(ranef = 'style')
n.obs.style %>% head()
```
Let's combine those data frames, and join with the coefficients. 

```{r}
n.obs = rbind(n.obs.nghd, n.obs.style)
dg = df %>%
  pivot_wider(names_from  = model, 
              values_from = c(est, se), 
              names_sep   = '.') %>%
  left_join(n.obs, 
            by = c('var', 'ranef')) 
head(dg)
tail(dg)
```
Note that Tudor doesn't explicit have a coefficient from output of the `glm` model. It is the minus the sum of the other coefficients, so that the sum of the coefficients is 0. 

```{r}
g = ggplot(dg %>% 
             filter(ranef == 'nghd'), 
       aes(x = est.glm, 
           y = est.glmer, 
           label = var))+
  geom_abline(slope = 1, 
              intercept = 0) + 
  geom_hline(yintercept = 0) + 
  geom_point(aes(size = n)) + 
  geom_text_repel(hjust = -.2, 
                  color = pubmediumgray)

g %>% pub()

```

Coefficients are almost identical, except for nghd 400 and 200. Those are neighborhoods with very few observations. 

```{r}
dg %>% 
  filter(ranef == 'nghd') %>%
  arrange(n) %>%
  head()
```
Here's another way to visualize the coefficients. 

```{r fig.height=6, fig.width=5}
dg2 = df %>%
  filter(ranef == 'nghd') %>%
  arrange(model, est) %>%
  mutate(var = factor(var, levels = unique(var))) %>%
  left_join(n.obs, 
            by = c('var', 'ranef'))
  

g = ggplot(dg2, 
       aes(y = var, 
           color = model, 
           size = n))+
  geom_vline(xintercept = 0, 
             color = pubmediumgray)+
  geom_point(aes(x = est)) + 
  geom_segment(aes(x     = est + se, 
                   xend  = est - se, 
                   y     = var, 
                   yend  = var), 
               linewidth = 0.5) 


g 

```

Neighborhoods 400 and 2000 the only ones that appear shrunk towards 0. Let's compare style coefficients. 

```{r}
dg3 = df %>%
  filter(ranef == 'style') %>%
  arrange(model, est) %>%
  mutate(var = factor(var, levels = unique(var))) %>%
  left_join(n.obs, 
            by = c('var', 'ranef'))
  

g = ggplot(dg3, 
       aes(y = var, 
           color = model, 
           size = n))+
  geom_vline(xintercept = 0, 
             color = pubmediumgray)+
  geom_point(aes(x = est)) + 
  geom_segment(aes(x     = est + se, 
                   xend  = est - se, 
                   y     = var, 
                   yend  = var), 
               linewidth = 0.5) 

g 

```
The coefficients are almost identical. Let's perform cross-validation to compare the models.

```{r}
set.seed(123)
k=5
folds = rep(1:k, 
            length.out = nrow(b))
b$fold = sample(folds, 
                nrow(b), 
                replace = F)

b[,c('lm', 'lmer')] = NA

for(j in 1:k){
  cat(j, '')
  
  train.rows  = b$fold != j 
  test.rows   = b$fold == j & b$style!='Tudor' & b$nghd!=400 & !is.na(b$nghd)
  
  b1.train =   lm(log.value ~ log.living +    style + beds +  nghd,
                  data=b[train.rows,])
  b2.train = lmer(log.value ~ log.living + (1|style) + beds + (1|nghd), 
                  data=b[train.rows,])
  
     b$lm[test.rows] = predict(b1.train, newdata = b[test.rows,])
   b$lmer[test.rows] = predict(b2.train, newdata = b[test.rows,], allow.new.levels=TRUE)
   

} ## end loop over k

b %>% select(value, living, nghd, log.value, lm, lmer)
```

```{r}
sqrt(mean((b$lm    - b$log.value)^2, na.rm=T))
sqrt(mean((b$lmer  - b$log.value)^2, na.rm=T))
```

RMSE is almost identical. 



## NHL shots

Let's do another example, one that will have different results. 

```{r}
dh = readRDS('data/nhl.shots.rds')
dh = dh %>% 
  filter(str == '5v5' &  ## 5-on-5 only
           !is.na(xcoord) &  ## remove shots with missing coordinates
           event != 'BLOCK', 
         empty == 0)  %>%  ## remove blocks
  mutate(abs.angle10 = abs.angle/10)

## Randomly sample 10,000 so the model doesn't take forever. 
#dh = dh[sample(1:nrow(dh), 20000, replace=F),]
n.shots = dh %>% 
  group_by(goalie) %>% 
  summarise(n = n(), 
            goals = sum(goal)) %>% 
  rename(var = goalie)
n.shots %>% head()

```

```{r}
m2   =   glm(goal ~ dist + abs.angle +    goalie , data=dh, family='binomial', contrasts=list(goalie = 'contr.sum'))
mer2 = glmer(goal ~ dist + abs.angle + (1|goalie), data=dh, family='binomial') 
```

```{r}
df = extract.ranef(mer2, m2)
head(df)
tail(df)
```

```{r fig.height=5, fig.width=5}
dg = df %>%
  pivot_wider(names_from = model, 
              values_from = c(est, se), 
              names_sep = '.') %>%
  left_join(n.shots, 
            by = 'var') %>%
  filter(var != '') %>%
  as.data.frame()

  
g = ggplot(dg %>% 
             filter(est.glm>-10), 
       aes(x = est.glm, 
           y = est.glmer, 
           label = var, 
           size = n))+
  geom_point(alpha = 0.5) + 
  geom_abline(slope = 1, 
              intercept = 0, 
              color = pubmediumgray) + 
  geom_hline(yintercept = 0, 
             linewidth = 0.5, 
             color = pubmediumgray)

g
```

```{r}
dg %>% arrange(     est.glm)
dg %>% arrange(desc(est.glm))
```

Goalies with 0 goals are have insane coefficients and standard errors. Let's get rid of them and refit the model.

```{r}
## keep only the goalies with more than 1 shot
goalies = n.shots %>% 
  filter(goals > 0, 
         goals != n, 
         n > 20) %>% 
  select(var) %>% 
  unlist()

dh = dh %>% 
  filter(goalie %in% goalies) 

m2   =   glm(goal ~ dist10 + abs.angle10 +    goalie , data=dh, family='binomial', contrasts=list(goalie = 'contr.sum'))
mer2 = glmer(goal ~ dist10 + abs.angle10 + (1|goalie), data=dh, family='binomial') 
```

Re-plot. 

```{r fig.height=5, fig.width=6}
df = extract.ranef(mer2, m2)

dg = df %>%
  pivot_wider(names_from = model, 
              values_from = c(est, se), 
              names_sep = '.') %>%
  left_join(n.shots, 
            by = 'var') %>%
  filter(var != '') %>%
  as.data.frame()
  
ggplot(dg %>% 
         filter(n>20), 
       aes(x = est.glm, 
           y = est.glmer, 
           color = ranef, 
           label = var, 
           size = n))+
  geom_abline(slope = 1, 
              intercept = 0) + 
  geom_hline(yintercept = 0) + 
  geom_segment(aes(xend = est.glm, 
                   y = est.glmer + se.glmer, 
                   yend = est.glmer - se.glmer), 
               color = pubblue, 
               linewidth = 0.25, 
               alpha = 0.3)+
  geom_segment(aes(xend = est.glm, 
                   y = est.glm + se.glm, 
                   yend = est.glm - se.glm), 
               color = pubred, 
               linewidth = 0.25, 
               alpha = 0.3, 
               position = position_jitter())+
  geom_point(alpha = 0.5, 
             color = pubblue) + 
  geom_point(aes(y = est.glm), 
             alpha = 0.5, 
             color = pubred) + 
  scale_x_continuous(limits=c(-1,1))+
  scale_y_continuous(limits=c(-1,1), oob=squish)+
  coord_cartesian(clip='off', expand=F)
```

```{r fig.height=8, fig.width=5}
dg1 = df %>%
  filter(ranef=='goalie') %>%
  left_join(n.shots, by='var') %>%
  arrange(model, est) %>%
  mutate(var = factor(var, levels=unique(var)))
  
  
ggplot(dg1, aes(y=var, color=model, size=n))+
  geom_vline(xintercept = 0) + 
  geom_point(aes(x=est)) + 
  geom_segment(aes(x    = est + se, 
                   xend = est - se, 
                   y    = var, 
                   yend = var), 
               linewidth=0.5) +
  scale_size(range=c(1, 3)) + 
  scale_x_continuous(limits=c(-1,1), oob=squish, expand=c(0,0))

```